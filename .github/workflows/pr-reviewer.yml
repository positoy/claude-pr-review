name: PR Reviewer

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to review
        required: true
        type: number

concurrency:
  group: pr-reviewer-${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20
  CLAUDE_CODE_VERSION: 2.0.50

jobs:
  review-pr:
    runs-on: [ubuntu-24.04]
    if: |
      (github.event.pull_request && !startsWith(github.event.pull_request.title, '.'))
      || (github.event.issue.pull_request && github.event.comment.body == '/review')
      || github.event.inputs.pr_number

    permissions:
      actions: read
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Get PR metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number
              || context.payload.issue?.number
              || context.payload.inputs?.pr_number;
            const prData = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput('number', prNumber);
            core.setOutput('head_ref', prData.data.head.ref);
            core.setOutput('head_sha', prData.data.head.sha);
            core.setOutput('base_ref', prData.data.base.ref);
            core.setOutput('base_sha', prData.data.base.sha);
            core.setOutput('title', prData.data.title || '');
            core.setOutput('body', prData.data.body || '');

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 30 # fetch commit count for diff

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Claude Code
        run: |
          npm install -g "@anthropic-ai/claude-code@${{ env.CLAUDE_CODE_VERSION }}"

      - name: Prepare PR review prompt
        id: prepare
        env:
          PR_HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          PR_HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          PR_BASE_REF: ${{ steps.pr.outputs.base_ref }}
          PR_BASE_SHA: ${{ steps.pr.outputs.base_sha }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          REVIEW_PROMPT=$(cat <<EOF
          # PR Review Request

          ## PR Context
          - **PR Base Branch**: $PR_BASE_REF
          - **PR Base SHA**: $PR_BASE_SHA
          - **PR Head Branch**: $PR_HEAD_REF
          - **PR Head SHA**: $PR_HEAD_SHA
          - **PR Title**: ${PR_TITLE:-'N/A'}

          ### PR Description
          \`\`\`markdown
          ${PR_BODY:-'N/A'}
          \`\`\`

          ---

          ## Your Tasks

          1. **Fetch latest changes** from remote repository
              - Execute \`git fetch origin\`
          2. **Analyze** the PR changes to identify modified files and lines
              - Using \`git diff $PR_BASE_SHA...$PR_HEAD_SHA\` output
          3. **Perform thorough code review** focusing on:
              - **Code Quality**: Logic errors, bugs, edge cases
              - **Best Practices**: Design patterns, code organization, naming conventions
              - **Performance**: Potential bottlenecks, inefficient algorithms
              - **Security**: Vulnerabilities, input validation, data exposure
              - **Critical Improvements**: Must-have optimizations
              - **Do NOT review code that is already correct or well-written**
          4. **Create a review JSON file** named \`review.json\` with the following structure:
              \`\`\`jsonc
              {
                "summary": { // Review summary
                  "event_type": "APPROVE", // Review type: "APPROVE" (default) or "REQUEST_CHANGES"
                  "overall_feedback": "Ï†ÑÎ∞òÏ†ÅÏúºÎ°ú Ïûò Íµ¨ÌòÑÎêòÏóàÏúºÎÇò Î™á Í∞ÄÏßÄ Í∞úÏÑ†ÏÇ¨Ìï≠Ïù¥ ÏûàÏäµÎãàÎã§.", // max 100 chars, 5 lines
                  "critical_issues": ["Î©îÏãúÏßÄ ÌÉÄÏûÖÏù¥ ÏûòÎ™ªÎê®"] // max 4 brief items (can be empty [] if none)
                },
                "line_comments": [ // Line-specific review comments (can be empty [] if no issues found)
                  {
                    "path": "file/path.java", // File path
                    "start_line": 30, // (Optional) Start line number for multi-line comment
                    "line": 42, // Line number
                    "start_side": "RIGHT", // (Optional) Start line side for multi-line comment: "RIGHT" for new, "LEFT" for old
                    "side": "RIGHT", // Line side: "RIGHT" for new, "LEFT" for old
                    "body": "üí° null Ï≤¥ÌÅ¨ÎèÑ Ìï®Íªò ÌïòÎäî Í≤ÉÏù¥ Îçî ÏïàÏ†ÑÌï©ÎãàÎã§." // Comment body (start with appropriate emoji)
                  }
                ]
              }
              \`\`\`

          ## IMPORTANT Notes
          - Focus review on PR-modified code only; minimize out-of-scope and excessive comments
          - Focus on meaningful issues (bugs, security, logic errors, etc.), not trivial styles
          - Select appropriate event_type:
            - \`APPROVE\`: Default for non-critical issues or minor suggestions (use this for most cases)
            - \`REQUEST_CHANGES\`: When critical issues (bugs, security, breaking changes) must be fixed before merge
          - Provide code examples (with diff codeblock) when suggesting improvements
          - Write all comments in Korean
          - Use appropriate emojis for categorization:
            - üêõ Bugs
            - üîí Security
            - ‚ö°Ô∏è Performance
            - üìù Documentation
            - üí° Suggestions
            - ‚ú® Best practices
            - üîç Code quality
          EOF
          )

          echo "prompt<<EOF
          $REVIEW_PROMPT
          EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_REQUEST: ${{ steps.prepare.outputs.prompt }}
        run: |
          # Run Claude Code in headless mode
          CLAUDE_RESPONSE=$(echo "$CLAUDE_REQUEST" | claude -p --dangerously-skip-permissions)
          echo -e "\nClaude Code Result:\n$CLAUDE_RESPONSE"

          # Check if review file was created
          if [ ! -f "review.json" ]; then
            echo "Claude Code did not generate review.json"
            exit 1
          fi

          # Validate JSON of review file
          jq empty review.json || {
            echo "Invalid JSON in review.json"
            exit 1
          }

          echo "review<<EOF
          $(cat review.json)
          EOF" >> $GITHUB_OUTPUT
          rm -f review.json

      - name: Filter review comments
        id: filter
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          CLAUDE_REVIEW: ${{ steps.claude.outputs.review }}
        with:
          script: |
            const reviewData = JSON.parse(process.env.CLAUDE_REVIEW);
            const reviewSummary = reviewData.summary ?? {};
            const lineComments = reviewData.line_comments ?? [];

            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: process.env.PR_NUMBER
            });

            const parseDiffPatch = (patch) => {
              // Unified diff format: @@ -oldStart[,oldCount] +newStart[,newCount] @@
              // Example: @@ -10,5 +12,7 @@ Îäî old ÌååÏùº 10Î≤à ÎùºÏù∏Î∂ÄÌÑ∞ 5Ï§Ñ, new ÌååÏùº 12Î≤à ÎùºÏù∏Î∂ÄÌÑ∞ 7Ï§Ñ ÏùòÎØ∏
              const hunkRegex = /^@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/gm;
              const hunks = Array.from(patch.matchAll(hunkRegex));

              return hunks.reduce((acc, match, index) => {
                const oldStart = parseInt(match[1], 10);
                const newStart = parseInt(match[3], 10);
                const hunkStart = match.index + match[0].length;
                const nextHunk = hunks[index + 1];
                const hunkFinish = nextHunk ? nextHunk.index : patch.length;
                const hunkContent = patch.substring(hunkStart, hunkFinish).trim();

                let oldLine = oldStart;
                let newLine = newStart;

                hunkContent.split('\n').forEach(line => {
                  // Lines starting with '-', '+', or ' ' (context)
                  if (line.startsWith('-')) {
                    acc.oldLines.add(oldLine++);
                  } else if (line.startsWith('+')) {
                    acc.newLines.add(newLine++);
                  } else if (line.startsWith(' ')) { // context line (Í≥µÎ∞±ÏúºÎ°ú ÏãúÏûë)
                    oldLine++;
                    newLine++;
                  }
                });

                return acc;
              }, { oldLines: new Set(), newLines: new Set() });
            };

            const { oldLinesPerFile, newLinesPerFile } = prFiles
              .filter(file => file.patch)
              .reduce((acc, file) => {
                const { oldLines, newLines } = parseDiffPatch(file.patch);

                acc.oldLinesPerFile.set(file.filename, oldLines);
                acc.newLinesPerFile.set(file.filename, newLines);

                return acc;
              }, { oldLinesPerFile: new Map(), newLinesPerFile: new Map() });

            const isInsideDiffHunk = (comment, oldLines, newLines) => {
              // start_lineÏóê ÎåÄÌïú Î≥ÑÎèÑ Í≤ÄÏÇ¨Îäî Î∂àÌïÑÏöî: GitHub APIÍ∞Ä multi-line ÏΩîÎ©òÌä∏Î•º Ï†úÏ∂úÌï† Îïå lineÎßå Ï≤¥ÌÅ¨ÌïòÎ©¥ Ï∂©Î∂ÑÌï®
              return (
                (comment.side === 'RIGHT' && newLines && newLines.has(comment.line))
                || (comment.side === 'LEFT' && oldLines && oldLines.has(comment.line))
              );
            };

            const { internalComments, externalComments } = lineComments.reduce((acc, comment) => {
              const oldLines = oldLinesPerFile.get(comment.path);
              const newLines = newLinesPerFile.get(comment.path);

              if (!isInsideDiffHunk(comment, oldLines, newLines)) {
                acc.externalComments.push(comment);
              } else {
                acc.internalComments.push(comment);
              }

              return acc;
            }, { internalComments: [], externalComments: [] });

            if (externalComments.length > 0) {
              console.log(`‚ö†Ô∏è Filtered external comments: ${JSON.stringify(externalComments)}`);
            }

            core.setOutput('summary', JSON.stringify(reviewSummary));
            core.setOutput('comments', JSON.stringify(internalComments));

      - name: Submit review comments
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          REVIEW_SUMMARY: ${{ steps.filter.outputs.summary }}
          REVIEW_COMMENTS: ${{ steps.filter.outputs.comments }}
        with:
          script: |
            const summary = JSON.parse(process.env.REVIEW_SUMMARY);
            const criticalIssues = summary.critical_issues ?? [];
            const eventType = summary.event_type ?? 'APPROVE';
            const comments = JSON.parse(process.env.REVIEW_COMMENTS);

            const summarySection = summary.overall_feedback
              ? `### üìä Ï†ÑÏ≤¥ Î¶¨Î∑∞ ÏöîÏïΩ\n${summary.overall_feedback}\n\n`
              : '';
            const criticalIssuesSection = criticalIssues.length > 0
              ? '### ‚ö†Ô∏è Ï§ëÏöî Ïù¥Ïäà\n' + criticalIssues.map(issue => `- ${issue}`).join('\n') + '\n\n'
              : '';
            const summaryBody = '## ü§ñ Claude Code Review\n\n' + summarySection + criticalIssuesSection;

            const review = await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: process.env.PR_NUMBER,
              body: summaryBody,
              event: eventType,
              comments: comments
            });

      - name: Submit failure comment
        if: failure()
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const commentBody = '## ‚ùå Claude Code Error\n\nAn error occurred while processing your request. ' +
              `Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) ` +
              'for details.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER,
              body: commentBody
            });
