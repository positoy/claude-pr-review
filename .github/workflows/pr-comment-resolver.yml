name: PR Comment Resolver

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: pr-comment-resolver-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.run_id }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20
  CLAUDE_CODE_VERSION: 2.0.50

jobs:
  analyze-pr-comment:
    if: |
      (github.event.issue.pull_request || github.event.pull_request) 
      && startsWith(github.event.comment.body, '@claude ')

    runs-on: [ubuntu-slim]

    outputs:
      pr_branch: ${{ steps.pr.outputs.head_ref }}
      user_prompt: ${{ steps.comment.outputs.user_prompt }}
      full_prompt: ${{ steps.comment.outputs.full_prompt }}

    steps:
      - name: Get PR metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, prData;
            core.setOutput('number', context.payload.issue);
            if (context.payload.issue) { // for issue_comment event
              prNumber = context.payload.issue.number;
              prData = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
            } else { // for pull_request_review_comment event
              prNumber = context.payload.pull_request.number;
              prData = {
                data: context.payload.pull_request
              };
            }

            core.setOutput('number', prNumber);
            core.setOutput('head_ref', prData.data.head.ref);
            core.setOutput('base_ref', prData.data.base.ref);
            core.setOutput('title', prData.data.title || '');
            core.setOutput('body', prData.data.body || '');

      - name: Get PR comment prompt
        id: comment
        env:
          COMMENT_JSON: ${{ toJSON(github.event.comment) }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          COMMENT_SUBJECT_TYPE: ${{ github.event.comment.subject_type }}
          PR_BASE_REF: ${{ steps.pr.outputs.base_ref }}
          PR_HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          # Remove @claude mentions and extract up to --- only
          USER_PROMPT=$(echo "$COMMENT_BODY" | sed 's/@claude //g; /^-\{3,\}\s*$/Q' | sed -z 's/^\s*//; s/\s*$//')
          echo -e "user_prompt<<EOF\n$USER_PROMPT\nEOF" >> $GITHUB_OUTPUT

          # Prepare full prompt with PR context
          FULL_PROMPT=$(cat <<EOF
          # PR Comment Resolution Request

          ## PR Context
          - **PR Base Branch**: $PR_BASE_REF
          - **PR Head Branch**: $PR_HEAD_REF
          - **PR Title**: ${PR_TITLE:-'N/A'}

          ### PR Description
          \`\`\`markdown
          ${PR_BODY:-'N/A'}
          \`\`\`

          ## PR Comment
          \`\`\`markdown
          $USER_PROMPT
          \`\`\`

          $([ -n "$COMMENT_SUBJECT_TYPE" ] && cat <<IEOF
          ### PR Comment Subject
          \`\`\`json
          $(echo "$COMMENT_JSON" | jq '
            if .subject_type == "line" then
              {
                path, 
                start_side, 
                side, 
                original_commit_id, 
                original_start_line, 
                original_line, 
                commit_id, 
                start_line, 
                line
              }
            else
              {
                path, 
                original_commit_id, 
                commit_id
              }
            end')
          \`\`\`
          IEOF
          )

          ---

          ## Your Tasks

          1. **Analyze** the PR changes in relation to the user's request above
          2. **Make modifications** to files in the current HEAD ref if needed
          3. **Commit changes** with the following format if you made any modifications:
              \`\`\`markdown
              \${Korean summary of changes in 20 words or less} ~ Resolve $COMMENT_URL

              ---
              User prompt: $USER_PROMPT

              ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
              \`\`\`
          4. **Push changes** to the HEAD ref branch
          5. **Provide a response** in the following format:
              \`\`\`markdown
              ## ü§ñ Claude Code Result

              \${Korean response of your actions or findings, excluding git operations (no more than 15 lines)}

              \${If changes committed: "‚úÖ Changes have been committed to this PR."}
              \`\`\`

          ## IMPORTANT Notes
          - Only commit and push if you made actual file changes
          - Strictly follow the commit message and response formats specified above
          - Ensure all changes are pushed to: $PR_HEAD_REF
          EOF
          )
          echo -e "full_prompt<<EOF\n$FULL_PROMPT\nEOF" >> $GITHUB_OUTPUT

  resolve-pr-comment:
    needs: analyze-pr-comment

    if: ${{ needs.analyze-pr-comment.outputs.user_prompt != '' }}

    runs-on: [ubuntu-slim]

    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.analyze-pr-comment.outputs.pr_branch }}
          fetch-depth: 30 # fetch commit count for diff

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Git and Claude Code
        env:
          GIT_USER_ID: ${{ github.event.comment.user.id }}
          GIT_USER_NAME: ${{ github.event.comment.user.login }}
          CLAUDE_CODE_VERSION: ${{ env.CLAUDE_CODE_VERSION }}
        run: |
          git config --global user.name "$GIT_USER_ID"
          git config --global user.email "$GIT_USER_ID+$GIT_USER_NAME@users.noreply.oss.navercorp.com"
          npm install -g "@anthropic-ai/claude-code@$CLAUDE_CODE_VERSION"

      - name: Run Claude Code
        id: claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_REQUEST: ${{ needs.analyze-pr-comment.outputs.full_prompt }}
        run: |
          # Run Claude Code in headless mode
          CLAUDE_RESPONSE=$(echo "$CLAUDE_REQUEST" | claude -p --dangerously-skip-permissions)
          echo -e "response<<EOF\n$CLAUDE_RESPONSE\nEOF" >> $GITHUB_OUTPUT

      - name: Reply success comment
        uses: actions/github-script@v7
        env:
          CLAUDE_RESPONSE: ${{ steps.claude.outputs.response }}
        with:
          script: |
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: process.env.CLAUDE_RESPONSE
              });
            } else {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: process.env.CLAUDE_RESPONSE
              });
            }

      - name: Reply failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = '## ‚ùå Claude Code Error\n\nAn error occurred while processing your request. ' +
              `Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) ` +
              'for details.';

            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: commentBody
              });
            } else {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: commentBody
              });
            }
